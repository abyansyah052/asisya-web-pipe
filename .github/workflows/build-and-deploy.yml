name: Build and Deploy to Hostinger VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Bisa di-trigger manual dari GitHub

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build Next.js app
        run: npm run build
        env:
          # Environment variables untuk build
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

      - name: ğŸ“ Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.ts deploy/
          cd deploy && zip -r ../build.zip .

      - name: ğŸ“¤ Upload to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "build.zip"
          target: "/var/www/asisya-web"

      - name: ğŸš€ Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/asisya-web
            
            echo "ğŸ“¦ Extracting build..."
            unzip -o build.zip
            rm build.zip
            
            echo "ğŸ“¥ Installing production dependencies..."
            npm ci --production
            
            echo "ğŸ”„ Restarting application..."
            pm2 restart asisya-web || pm2 start npm --name "asisya-web" -- start
            pm2 save
            
            echo "âœ… Deploy complete!"

      - name: âœ… Deployment successful
        run: echo "ğŸ‰ Successfully deployed to ${{ secrets.NEXT_PUBLIC_APP_URL }}"
